trigger:
- master

resources:
- repo: self 

variables:
  tag: '$(Build.BuildId)'

pr:
- "*"


stages:
- stage: Build
  jobs:
  - job: BuildJob
    pool:
      vmImage: ubuntu-latest

    steps:
    - task: Docker@1
      displayName: 'Build the Docker image'
      inputs:
        #containerregistrytype: 'Docker Hub'
        containerRegistry: 'dockerRegistryServiceConnection'
        command: 'Build an image'
        dockerFile: '$(Build.SourcesDirectory)/flask/Dockerfile'
        #imageName: '$(ImageName)'
        buildContext: '$(Build.SourcesDirectory)/app.py'
        repository: $(DOCKER_REPOSITORY_NAME)
      env:
        DOCKER_USERNAME: $(DOCKER_USERNAME)
        DOCKER_PASSWORD: $(DOCKER_PASSWORD)

  
    - task: Docker@2
      displayName: 'Push the Docker image to Dockerhub'
      inputs:
        containerregistrytype: 'Docker Hub'
        containerRegistry: 'dockerRegistryServiceConnection'
        command: 'Push  '
        imageName: '$(ImageName)'
        DOCKER_REPOSITORY_NAME: 'my-flask-app-new'
      env:
        DOCKER_USERNAME: $(DOCKER_USERNAME)
        DOCKER_PASSWORD: $(DOCKER_PASSWORD)
        
      
    #steps:
    #- script: echo "Building the Docker image..."
    #  displayName: 'Building Docker Image'

    #- script: |
    #    cd /flask
    #    docker build -t my-flask-app .
    #  displayName: 'Build Docker Image'
    #  continueOnError: true  # Continue even if the build fails to allow deployment step to run

   # - task: Docker@2
   #   inputs:
   #     command: 'login'
   #     containerRegistry: 'dockerRegistryServiceConnection'  # Specify the name of your Docker registry service connection in Azure DevOps
   #   displayName: 'Login to Docker Hub'
   #   env:
   #     DOCKER_USERNAME: $(DOCKER_USERNAME)
   #    DOCKER_PASSWORD: $(DOCKER_PASSWORD)
    
   # - script: |
   #     cd flask
   #     docker tag my-flask-app shruti1402/my-flask-app:latest
   #     docker push shruti1402/my-flask-app:latest
   #   displayName: 'Push Docker Image'



  - job: DeployFlaskAppToEC2
    deployment: DeployJob
    environment: 'test'
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.x'
        addToPath: true
      displayName: 'Use Python 3.x'

    - script: |
        cd /flask
        ssh -o StrictHostKeyChecking=no -i $EC2_SSH_KEY ubuntu@52.73.82.30 'sudo docker login -u shruti1402 -p Shruti@1402'
        ssh -o StrictHostKeyChecking=no -i $EC2_SSH_KEY ubuntu@52.73.82.30 'sudo docker stop my-flask-app-new || true'
        ssh -o StrictHostKeyChecking=no -i $EC2_SSH_KEY ubuntu@52.73.82.30 'sudo docker rm my-flask-app-new || true'
        ssh -o StrictHostKeyChecking=no -i $EC2_SSH_KEY ubuntu@52.73.82.30 'sudo docker pull shruti1402/my-flask-app-new:latest'
        ssh -o StrictHostKeyChecking=no -i $EC2_SSH_KEY ubuntu@52.73.82.30 'sudo    docker run -d --name my-flask-app-new -p 8000:8000 shruti1402/my-flask-app-new:latest'
      displayName: 'Pull and Run Docker Image on EC2'
      env:
        EC2_SSH_KEY: $(EC2_SSH_KEY)
        USERNAME: ubuntu
        HOST: $(HOST_DNS)
